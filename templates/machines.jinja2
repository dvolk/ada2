{% extends 'base.jinja2' %}

{% block content %}

  <h2>{{ gettext('Create new machine') }}</h2>

  {{ info(gettext("This lists all templates that are available to the group you are in: {g}"), g=current_user.group.name) }}

  <p>
    {% if current_user.is_admin %}
      {% set mts = MachineTemplate.query.all() %}
    {% else %}
      {% set mts = current_user.group.machine_templates %}
    {% endif %}
    {% for mt in mts %}
      <p>
        <div class="w3-card w3-padding w3-round">
          <div class="w3-row" style="display: flex; align-items: center;">
            <div class="w3-col m8" style="display: flex; align-items: center;">
              <h3>{{ icon('file-lines') }} {{ mt.name }}</h3>
            </div>
            <div class="w3-col m4 w3-right-align">
              <form method="POST" action="/new_machine">
                <input type="hidden" name="machine_template_name" value="{{ mt.name }}">
                <button
                  title="Launch an instance of this machine template"
                  type="submit"
                  class="w3-button w3-green w3-round">
                  {{ icon("plus-circle") }} {{ gettext('Launch instance') }}
                </button>
              </form>
            </div>
          </div>
          <div class="w3-row">
            <div class="w3-col m8">
              <p>{{ mt.description }}</p>
              <p>Created: {{ humanize.naturaldelta(now - mt.creation_date) }} ago</p>
            </div>
            <div class="w3-col m4 w3-right-align">
              <p>
                Group: {{ mt.group.name }}<br/>
                Provider: {{ mt.machine_provider.name }}<br/>
                {% if mt.memory_limit_gb %}
                  Memory (GB): {{ mt.memory_limit_gb }}<br/>
                {% endif %}
                {% if mt.memory_limit_gb %}
                  CPU (cores): {{ mt.cpu_limit_cores }}<br/>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </p>
    {% endfor %}
  </p>


  <h2>{{ gettext('List of machines') }}</h2>
  {{ info(gettext("This lists all machines you have access to, both your own and those shared with you by other users.")) }}
  <p>
    {% for machine in current_user.owned_machines|reverse|list + current_user.shared_machines|reverse|list if machine.state not in [MachineState.DELETED, MachineState.DELETING] %}
      {% if machine.hostname and machine.machine_template.extra_data.get("has_https", False) %}
        {% set machine_url = "https://" + machine.hostname %}
      {% else %}
        {% set machine_url = "http://" + machine.ip %}
      {% endif %}
      <p>
        <div class="w3-card w3-padding w3-round">
          <div class="w3-row" style="display: flex; align-items: center;">
            <div class="w3-col m6" style="display: flex; align-items: center;">
              <h3>
                {{ icon('cube') }} {{ machine.name }}
              </h3>

            </div>
            <div class="w3-col m6 w3-right-align">
              {% if machine.state == MachineState.READY %}
                <a
                  target="_blank"
                  title="Open machine page"
                  href="{{ machine_url }}/Sw8OSELATBzI74XT"
                  class="w3-button w3-blue w3-round">
                  {{ icon("external-link") }} {{ gettext('Open') }}
                </a>
              {% elif machine.state == MachineState.PROVISIONING %}
                <button
                  title="Machine is being prepared. Refresh page to update status"
                  class="w3-button w3-blue w3-round" disabled>
                  <i class="fa-solid fa-spinner fa-spin"></i> PROVISIONING
                </button>
              {% else %}
                <button
                  title="Machine is in error state"
                  class="w3-button w3-red w3-round" disabled>
                  {{ icon("circle-xmark") }} {{ machine.state.name }}
                </button>
              {% endif %}
              <a href="/share_machine/{{ machine.id }}"
                 class="w3-button w3-blue w3-round"
                 title="Open share page for machine">
                 {{ icon('share-nodes') }}
              </a>
              {% if machine.owner == current_user %}
                <button
                  class="w3-button w3-blue w3-round"
                  title="Rename machine"
                  onclick="renameObject('{{ machine.name }}', {{ machine.id }})"
                  >
                  {{ icon('pen') }}
                </button>
              {% endif %}
              <a href="{{ url_for('report_problem', machine_name=machine.name, title=gettext('Problem with machine ') + machine.name ) }}"
                 class="w3-button w3-blue-gray w3-round"
                 title={{ gettext("Report problem") }}>
                 {{ icon('flag') }}
              </a>
              {% if machine.owner == current_user %}
                <a href="#"
                   onclick="document.getElementById('stop-form-{{ machine.id }}').submit();"
                   class="w3-button w3-red w3-round"
                   title={{ gettext("Stop and remove machine") }}>
                   {{ icon('trash') }}
                </a>
                <form id="stop-form-{{ machine.id }}" action="/stop_machine" method="POST">
                  <input type="hidden" name="machine_id" value="{{ machine.id }}">
                </form>
              {% endif %}

            </div>
          </div>
          <div class="w3-row">
            <div class="w3-col m8">
              <p>
                <a href="{{ machine_url }}/Sw8OSELATBzI74XT" target="_blank">

                  <div class="fallback-div" style="display: none; width: 240px; height: 140px; border: 3px dashed gray; text-align: center; line-height: 140px; border-radius:4px">Thumbnail Not Available</div>
                  <img class="vm-thumbnail w3-round lighten-on-hover blur-on-hover" src="{{ machine_url }}/screenshots/screenshot-thumb.png" alt="Alternative text" style="display: none; max-width: 300px; max-height: 175px;">
                </a>
              </p>
            </div>
            <div class="w3-col m4 w3-right-align">
              <p>
                Template: {{ machine.machine_template.name }}<br/>
                {% if machine.owner.id != current_user.id %}
                  Shared with you by: {{ machine.owner.username }}<br/>
                {% else %}
                  Owner: {{ machine.owner.username }}<br/>

                  {% if machine.shared_users %}
                    Shared with other users: {{ machine.shared_users|join(", ", attribute="username") }}<br/>
                  {% endif %}
                {% endif %}
                {% if machine.ip %}
                  IP: {{ machine.ip }}<br/>
                {% endif %}
                Created: {{ humanize.naturaldelta(now - machine.creation_date) }} ago
              </p>
              {% if machine.data_transfer_jobs %}
                <p>Data:<br/>
                  {% for job_fmt in machine_format_dtj(machine) %}
                    {{ job_fmt }}<br/>
                  {% endfor %}
                </p>
              {% endif %}
            </div>
          </div>
        </div>
      </p>
    {% endfor %}
  </p>
  <br/>
{% endblock %}

{% block javascript %}
  <script>
    function renameObject(objectName, objectId) {
      var newName = prompt("Enter a new name for " + objectName + ":", objectName);
      if (newName !== null && newName !== objectName) {
        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/rename_machine");

        var oldNameInput = document.createElement("input");
        oldNameInput.setAttribute("type", "hidden");
        oldNameInput.setAttribute("name", "machine_id");
        oldNameInput.setAttribute("value", objectId);
        form.appendChild(oldNameInput);

        var newNameInput = document.createElement("input");
        newNameInput.setAttribute("type", "hidden");
        newNameInput.setAttribute("name", "machine_new_name");
        newNameInput.setAttribute("value", newName);
        form.appendChild(newNameInput);

        document.body.appendChild(form);

        form.submit();
      }
    }
    document.addEventListener('DOMContentLoaded', function() {
      function displayThumbnail(thumbnail, fallbackDiv) {
        if (thumbnail.naturalWidth === 0) {
          fallbackDiv.style.display = 'block';
        } else {
          thumbnail.style.display = 'inline-block';
          fallbackDiv.style.display = 'none';
        }
      }

      var thumbnails = document.getElementsByClassName('vm-thumbnail');
      var fallbackDivs = document.getElementsByClassName('fallback-div');

      for (var i = 0; i < thumbnails.length; i++) {
        (function(i) {
          if (thumbnails[i].complete) {
            displayThumbnail(thumbnails[i], fallbackDivs[i]);
          } else {
            thumbnails[i].addEventListener('load', function() {
              displayThumbnail(thumbnails[i], fallbackDivs[i]);
            });

            thumbnails[i].addEventListener('error', function() {
              fallbackDivs[i].style.display = 'block';
            });
          }
        })(i);
      }
    });
  </script>
{% endblock %}
